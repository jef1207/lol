<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Аэрохоккей - исправленная версия</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            font-family: 'Arial', sans-serif;
            color: white;
        }
        
        #gameCanvas {
            border: 4px solid #0f3460;
            border-radius: 10px;
            box-shadow: 0 0 40px rgba(0, 150, 255, 0.3);
            background-color: #111;
        }
        
        .controls {
            margin-top: 20px;
            text-align: center;
            background: rgba(15, 52, 96, 0.7);
            padding: 15px;
            border-radius: 10px;
            width: 800px;
        }
        
        .player {
            display: inline-block;
            margin: 0 30px;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .player1 {
            background-color: #3498db;
            color: white;
        }
        
        .player2 {
            background-color: #e74c3c;
            color: white;
        }
        
        .score {
            font-size: 24px;
            margin: 10px 0;
        }
        
        .instructions {
            margin-top: 15px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        h1 {
            color: #4cc9f0;
            text-shadow: 0 0 10px rgba(76, 201, 240, 0.5);
            margin-bottom: 10px;
        }
        
        .reset-btn {
            margin-top: 15px;
            padding: 10px 25px;
            background: #4cc9f0;
            border: none;
            border-radius: 5px;
            color: #16213e;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: #2fa4d6;
            transform: scale(1.05);
        }
        
        .debug {
            margin-top: 10px;
            font-size: 12px;
            color: #aaa;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>АЭРОХОККЕЙ (ИСПРАВЛЕННАЯ ВЕРСИЯ)</h1>
    <canvas id="gameCanvas" width="800" height="500"></canvas>
    
    <div class="controls">
        <div class="score">
            <span class="player player1">Игрок 1: <span id="score1">0</span></span>
            <span style="margin: 0 20px;">:</span>
            <span class="player player2">Игрок 2: <span id="score2">0</span></span>
        </div>
        
        <div class="instructions">
            <div><span class="player1">Игрок 1:</span> W (вверх), S (вниз), A (влево), D (вправо)</div>
            <div><span class="player2">Игрок 2:</span> Стрелки ← ↑ → ↓</div>
        </div>
        
        <button class="reset-btn" onclick="resetGame()">Новая игра</button>
        <div class="debug" id="debugInfo"></div>
    </div>

    <script>
        // Получаем элементы
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const score1Element = document.getElementById('score1');
        const score2Element = document.getElementById('score2');
        const debugInfo = document.getElementById('debugInfo');

        // Размеры поля
        const FIELD_WIDTH = canvas.width;
        const FIELD_HEIGHT = canvas.height;
        const CENTER_X = FIELD_WIDTH / 2;
        const CENTER_Y = FIELD_HEIGHT / 2;

        // Игровые объекты
        const game = {
            puck: {
                x: CENTER_X,
                y: CENTER_Y,
                radius: 15,
                speedX: 5,
                speedY: 3,
                color: '#f1c40f'
            },
            
            player1: {
                x: 80,
                y: CENTER_Y,
                width: 20,
                height: 80,
                speed: 8,
                color: '#3498db',
                score: 0,
                keys: { up: 'KeyW', down: 'KeyS', left: 'KeyA', right: 'KeyD' }
            },
            
            player2: {
                x: FIELD_WIDTH - 80,
                y: CENTER_Y,
                width: 20,
                height: 80,
                speed: 8,
                color: '#e74c3c',
                score: 0,
                keys: { up: 'ArrowUp', down: 'ArrowDown', left: 'ArrowLeft', right: 'ArrowRight' }
            },
            
            // Состояния клавиш
            keysPressed: {},
            
            // Центральная линия и ворота
            centerLine: {
                color: '#0f3460',
                width: 4,
                dashLength: 20
            },
            
            goals: {
                width: 15,
                height: 150,
                color: '#7f8c8d'
            },
            
            // Флаги для отслеживания состояния игры
            gameActive: true,
            lastUpdate: 0
        };

        // Обработчики клавиш
        window.addEventListener('keydown', (e) => {
            game.keysPressed[e.code] = true;
            
            // Пробел для паузы
            if (e.code === 'Space') {
                game.gameActive = !game.gameActive;
                if (game.gameActive) {
                    game.lastUpdate = Date.now();
                    requestAnimationFrame(gameLoop);
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            game.keysPressed[e.code] = false;
        });

        // Функция рисования
        function draw() {
            // Очищаем canvas
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, FIELD_WIDTH, FIELD_HEIGHT);
            
            // Рисуем центральную линию (пунктир)
            ctx.beginPath();
            ctx.setLineDash([game.centerLine.dashLength, game.centerLine.dashLength]);
            ctx.moveTo(CENTER_X, 0);
            ctx.lineTo(CENTER_X, FIELD_HEIGHT);
            ctx.strokeStyle = game.centerLine.color;
            ctx.lineWidth = game.centerLine.width;
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Рисуем центральный круг
            ctx.beginPath();
            ctx.arc(CENTER_X, CENTER_Y, 50, 0, Math.PI * 2);
            ctx.strokeStyle = '#0f3460';
            ctx.lineWidth = 4;
            ctx.stroke();
            
            // Рисуем ворота
            // Левые ворота
            ctx.fillStyle = game.goals.color;
            ctx.fillRect(0, (FIELD_HEIGHT - game.goals.height) / 2, game.goals.width, game.goals.height);
            
            // Правые ворота
            ctx.fillRect(FIELD_WIDTH - game.goals.width, (FIELD_HEIGHT - game.goals.height) / 2, game.goals.width, game.goals.height);
            
            // Рисуем игроков
            drawPlayer(game.player1);
            drawPlayer(game.player2);
            
            // Рисуем шайбу
            drawPuck();
            
            // Отображаем информацию для отладки
            debugInfo.textContent = `Шайба: X=${Math.round(game.puck.x)}, Y=${Math.round(game.puck.y)}, VX=${game.puck.speedX.toFixed(2)}, VY=${game.puck.speedY.toFixed(2)}`;
        }

        function drawPlayer(player) {
            ctx.fillStyle = player.color;
            ctx.fillRect(
                player.x - player.width / 2,
                player.y - player.height / 2,
                player.width,
                player.height
            );
            
            // Закругленные края
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.arc(
                player.x - player.width / 2,
                player.y - player.height / 2,
                5, 0, Math.PI * 2
            );
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(
                player.x - player.width / 2,
                player.y + player.height / 2,
                5, 0, Math.PI * 2
            );
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(
                player.x + player.width / 2,
                player.y - player.height / 2,
                5, 0, Math.PI * 2
            );
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(
                player.x + player.width / 2,
                player.y + player.height / 2,
                5, 0, Math.PI * 2
            );
            ctx.fill();
        }

        function drawPuck() {
            ctx.fillStyle = game.puck.color;
            ctx.beginPath();
            ctx.arc(game.puck.x, game.puck.y, game.puck.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // Эффект объема
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.beginPath();
            ctx.arc(
                game.puck.x - game.puck.radius / 3,
                game.puck.y - game.puck.radius / 3,
                game.puck.radius / 2,
                0, Math.PI * 2
            );
            ctx.fill();
        }

        // Обновление игры
        function update() {
            // Двигаем игроков
            movePlayer(game.player1);
            movePlayer(game.player2);
            
            // Двигаем шайбу
            game.puck.x += game.puck.speedX;
            game.puck.y += game.puck.speedY;
            
            // Проверяем столкновения шайбы с границами поля
            checkBoundaries();
            
            // Проверяем голы
            checkGoals();
            
            // Проверяем столкновения с игроками
            checkCollision(game.player1);
            checkCollision(game.player2);
            
            // Ограничиваем скорость шайбы
            const maxSpeed = 15;
            const currentSpeed = Math.sqrt(game.puck.speedX * game.puck.speedX + game.puck.speedY * game.puck.speedY);
            if (currentSpeed > maxSpeed) {
                game.puck.speedX = (game.puck.speedX / currentSpeed) * maxSpeed;
                game.puck.speedY = (game.puck.speedY / currentSpeed) * maxSpeed;
            }
            
            // Добавляем небольшое трение
            game.puck.speedX *= 0.995;
            game.puck.speedY *= 0.995;
        }

        function checkBoundaries() {
            // Верхняя граница
            if (game.puck.y - game.puck.radius <= 0) {
                game.puck.y = game.puck.radius; // Возвращаем шайбу на границу
                game.puck.speedY = Math.abs(game.puck.speedY) * 0.9; // Отскок с потерей энергии
            }
            
            // Нижняя граница
            if (game.puck.y + game.puck.radius >= FIELD_HEIGHT) {
                game.puck.y = FIELD_HEIGHT - game.puck.radius; // Возвращаем шайбу на границу
                game.puck.speedY = -Math.abs(game.puck.speedY) * 0.9; // Отскок с потерей энергии
            }
            
            // Левая граница (не ворота)
            if (game.puck.x - game.puck.radius <= game.goals.width) {
                // Проверяем, не в воротах ли шайба по Y
                if (game.puck.y < (FIELD_HEIGHT - game.goals.height) / 2 || 
                    game.puck.y > (FIELD_HEIGHT + game.goals.height) / 2) {
                    game.puck.x = game.goals.width + game.puck.radius; // Возвращаем шайбу на границу
                    game.puck.speedX = Math.abs(game.puck.speedX) * 0.9; // Отскок
                }
            }
            
            // Правая граница (не ворота)
            if (game.puck.x + game.puck.radius >= FIELD_WIDTH - game.goals.width) {
                // Проверяем, не в воротах ли шайба по Y
                if (game.puck.y < (FIELD_HEIGHT - game.goals.height) / 2 || 
                    game.puck.y > (FIELD_HEIGHT + game.goals.height) / 2) {
                    game.puck.x = FIELD_WIDTH - game.goals.width - game.puck.radius; // Возвращаем шайбу на границу
                    game.puck.speedX = -Math.abs(game.puck.speedX) * 0.9; // Отскок
                }
            }
            
            // Дополнительная защита: если шайба все же ушла за пределы, вернем ее
            if (game.puck.x < -game.puck.radius * 2 || 
                game.puck.x > FIELD_WIDTH + game.puck.radius * 2 ||
                game.puck.y < -game.puck.radius * 2 || 
                game.puck.y > FIELD_HEIGHT + game.puck.radius * 2) {
                console.warn("Шайба вышла за пределы поля, возвращаем в центр");
                resetPuck();
            }
        }

        function movePlayer(player) {
            // Двигаем вверх/вниз
            if (game.keysPressed[player.keys.up] && player.y - player.height / 2 > 0) {
                player.y -= player.speed;
            }
            if (game.keysPressed[player.keys.down] && player.y + player.height / 2 < FIELD_HEIGHT) {
                player.y += player.speed;
            }
            
            // Двигаем влево/вправо с ограничениями
            if (game.keysPressed[player.keys.left]) {
                if (player === game.player1 && player.x - player.width / 2 > game.goals.width + 5) {
                    player.x -= player.speed;
                } else if (player === game.player2 && player.x - player.width / 2 > CENTER_X + 10) {
                    player.x -= player.speed;
                }
            }
            if (game.keysPressed[player.keys.right]) {
                if (player === game.player1 && player.x + player.width / 2 < CENTER_X - 10) {
                    player.x += player.speed;
                } else if (player === game.player2 && player.x + player.width / 2 < FIELD_WIDTH - game.goals.width - 5) {
                    player.x += player.speed;
                }
            }
        }

        function checkCollision(player) {
            // Вычисляем ближайшую точку на прямоугольнике игрока к центру шайбы
            const closestX = Math.max(player.x - player.width / 2, 
                                     Math.min(game.puck.x, player.x + player.width / 2));
            const closestY = Math.max(player.y - player.height / 2, 
                                     Math.min(game.puck.y, player.y + player.height / 2));
            
            const distanceX = game.puck.x - closestX;
            const distanceY = game.puck.y - closestY;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
            
            if (distance < game.puck.radius) {
                // Находим нормаль столкновения
                let normalX, normalY;
                if (distance === 0) {
                    // Если центры совпали (редкий случай)
                    normalX = game.puck.x - player.x;
                    normalY = game.puck.y - player.y;
                    const length = Math.sqrt(normalX * normalX + normalY * normalY);
                    normalX /= length;
                    normalY /= length;
                } else {
                    normalX = distanceX / distance;
                    normalY = distanceY / distance;
                }
                
                // Добавляем скорость от движения игрока
                let playerSpeedX = 0;
                let playerSpeedY = 0;
                
                if (game.keysPressed[player.keys.up]) playerSpeedY = -1.5;
                if (game.keysPressed[player.keys.down]) playerSpeedY = 1.5;
                if (game.keysPressed[player.keys.left]) playerSpeedX = -1.5;
                if (game.keysPressed[player.keys.right]) playerSpeedX = 1.5;
                
                // Обновляем скорость шайбы с учетом упругости
                const elasticity = 1.1; // Коэффициент упругости
                game.puck.speedX = (normalX * 8 + playerSpeedX) * elasticity;
                game.puck.speedY = (normalY * 8 + playerSpeedY) * elasticity;
                
                // Сдвигаем шайбу, чтобы избежать залипания
                const overlap = game.puck.radius - distance + 1;
                game.puck.x += normalX * overlap;
                game.puck.y += normalY * overlap;
                
                // Звуковой эффект (имитация)
                playHitSound();
            }
        }

        function checkGoals() {
            // Проверяем левые ворота
            if (game.puck.x - game.puck.radius <= game.goals.width) {
                if (game.puck.y > (FIELD_HEIGHT - game.goals.height) / 2 && 
                    game.puck.y < (FIELD_HEIGHT + game.goals.height) / 2) {
                    game.player2.score++;
                    score2Element.textContent = game.player2.score;
                    showGoalAnimation("Игрок 2 забил гол!");
                    resetPuck();
                    return;
                }
            }
            
            // Проверяем правые ворота
            if (game.puck.x + game.puck.radius >= FIELD_WIDTH - game.goals.width) {
                if (game.puck.y > (FIELD_HEIGHT - game.goals.height) / 2 && 
                    game.puck.y < (FIELD_HEIGHT + game.goals.height) / 2) {
                    game.player1.score++;
                    score1Element.textContent = game.player1.score;
                    showGoalAnimation("Игрок 1 забил гол!");
                    resetPuck();
                    return;
                }
            }
        }

        function showGoalAnimation(message) {
            // Простая анимация гола
            ctx.save();
            ctx.font = "bold 40px Arial";
            ctx.fillStyle = "#f1c40f";
            ctx.textAlign = "center";
            ctx.shadowColor = "rgba(241, 196, 15, 0.8)";
            ctx.shadowBlur = 20;
            ctx.fillText(message, CENTER_X, 100);
            ctx.restore();
            
            // Через 1 секунду анимация исчезнет
            setTimeout(() => {
                // Перерисовываем поле
                draw();
            }, 1000);
        }

        function resetPuck() {
            game.puck.x = CENTER_X;
            game.puck.y = CENTER_Y;
            
            // Случайное направление после гола
            game.puck.speedX = (Math.random() > 0.5 ? 1 : -1) * 5;
            game.puck.speedY = (Math.random() > 0.5 ? 1 : -1) * 3;
            
            // Сбрасываем позиции игроков
            game.player1.x = 80;
            game.player1.y = CENTER_Y;
            
            game.player2.x = FIELD_WIDTH - 80;
            game.player2.y = CENTER_Y;
        }

        function resetGame() {
            game.player1.score = 0;
            game.player2.score = 0;
            score1Element.textContent = '0';
            score2Element.textContent = '0';
            
            // Сброс позиций
            game.player1.x = 80;
            game.player1.y = CENTER_Y;
            
            game.player2.x = FIELD_WIDTH - 80;
            game.player2.y = CENTER_Y;
            
            resetPuck();
        }

        // Имитация звука удара
        function playHitSound() {
            // В реальной игре здесь был бы Audio объект
            // Для примера просто выводим в консоль
            console.log('Хит!');
        }

        // Игровой цикл
        function gameLoop() {
            if (!game.gameActive) {
                // Если игра на паузе, показываем сообщение
                ctx.save();
                ctx.font = "30px Arial";
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.textAlign = "center";
                ctx.fillText("ПАУЗА (нажмите ПРОБЕЛ)", CENTER_X, CENTER_Y);
                ctx.restore();
                return;
            }
            
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Запуск игры
        resetPuck();
        game.lastUpdate = Date.now();
        gameLoop();

        // Инструкции при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            draw();
        });
    </script>
</body>
</html>
